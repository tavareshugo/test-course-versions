name: Create Archive Version

on:
  push:
    tags:
      - '20[2-9][0-9].[0-1][0-9].[0-3][0-9]'  # Matches YYYY.MM.DD format

jobs:
  create-archive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout tagged version
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}  # This checks out the tagged commit
    
    - name: Setup Quarto
      uses: quarto-dev/quarto-actions/setup@v2
        
    - name: Extract tag name
      id: tag
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
    - name: Add warning header for archived version
      run: |
      cat <<EOF >> _quarto.yml
    body-header: |
      :::{.callout-warning}
      <font size='+2'>This is an archived version of the course - please consider using the [latest version](../../index.html).</font>
      :::
    EOF

    - name: Render tagged version
      run: |
        quarto render
        
    - name: Prepare archive directory
      run: |
        # Rename _site to the tag name
        mv _site ${{ steps.tag.outputs.tag_name }}
        echo "Archive directory created: ${{ steps.tag.outputs.tag_name }}"
        
    - name: Checkout gh-pages branch for archive
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        path: _site
        
    - name: Setup archive structure
      run: |
        # Create archive directory if it doesn't exist
        mkdir -p _site/archive
        
        # Copy the new version into the archive
        cp -r ${{ steps.tag.outputs.tag_name }} _site/archive/

        # List contents for verification
        echo "Archive contents:"
        ls -la _site/archive/
        
    - name: Publish
      uses: JamesIves/github-pages-deploy-action@4.1.0
      with:
        branch: gh-pages
        folder: _site
        single-commit: true